{"version":3,"file":"content/content.js","mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qEAAqE,sBAAsB;AAC3F;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gEAAgE,mBAAmB;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,WAAW;AACX;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA,+CAA+C,cAAc,IAAI;AACjE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,gDAAgD;AAChD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wCAAwC;AACxC;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6CAA6C;AAC7C;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc,gBAAgB;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B;AAC/B,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B;AAC7B,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA,YAAY,yBAAyB;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD","sources":["webpack://ai-browser-assistant/./src/content/content.js"],"sourcesContent":["// 将需要导入的内容直接定义在文件中\r\nconst CONFIG = {\r\n  adIndicators: [\r\n    'ad', 'ads', 'advertisement', 'sponsored', 'promotion',\r\n    'banner', 'adsense', 'adwords', 'doubleclick'\r\n  ],\r\n  commonAdSizes: [\r\n    [728, 90],  // Leaderboard\r\n    [300, 250], // Medium Rectangle\r\n    [160, 600]  // Wide Skyscraper\r\n  ]\r\n};\r\n\r\nclass ContentAnalyzer {\r\n  constructor() {\r\n    this.filterSearchResults = []; // 添加数组存储过滤后的搜索结果\r\n    console.trace('ContentAnalyzer constructor called');\r\n    this.features = {\r\n      adBlocking: true,\r\n      searchReordering: true,\r\n      contextSuggestions: true\r\n    };\r\n    this.loadFeatureSettings().then(() => {\r\n      this.initialize();\r\n    });\r\n  }\r\n\r\n  async initialize() {\r\n    try {\r\n      // 初始化配置\r\n      const config = await this.getAPIConfig();\r\n      console.log('Initialized with config:', config);\r\n      \r\n      // 等待 DOM 加载完成\r\n      if (document.readyState === 'loading') {\r\n        document.addEventListener('DOMContentLoaded', () => this.onDOMReady());\r\n      } else {\r\n        this.onDOMReady();\r\n      }\r\n    } catch (error) {\r\n      console.error('Initialization failed:', error);\r\n    }\r\n  }\r\n\r\n  onDOMReady() {\r\n    // 初始分析当前页面内容\r\n    this.analyzeExistingContent();\r\n  }\r\n\r\n  async analyzeExistingContent() {\r\n    // 获取搜索关键词\r\n    const searchQuery = this.getSearchQuery();\r\n    if (!searchQuery) return;\r\n    \r\n    // 获取搜索结果\r\n    const searchResults = this.getSearchResultsByEngine();\r\n    if (!searchResults.length) return;\r\n  \r\n    // 清空之前的结果数组\r\n    this.filterSearchResults = [];\r\n  \r\n    // 创建一个Promise数组来存储所有分析任务\r\n    const analysisPromises = searchResults.map(async result => {\r\n      let shouldInclude = true;\r\n      let relevanceScore = 0;\r\n  \r\n      // 广告分析\r\n      if (this.features.adBlocking) {\r\n        const isAd = await this.analyzeSearchResult(result, searchQuery);\r\n        if (isAd) {\r\n          result.classList.add('ai-assistant-blocked');\r\n          result.style.display = 'none';\r\n          shouldInclude = false;\r\n        } else {\r\n          result.classList.remove('ai-assistant-blocked');\r\n          result.style.display = '';\r\n        }\r\n      }\r\n  \r\n      // 相关性分析\r\n      if (shouldInclude) {\r\n        relevanceScore = this.features.searchReordering ? \r\n          await this.calculateRelevance(result, searchQuery) : \r\n          0;\r\n        \r\n        return {\r\n          element: result,\r\n          score: relevanceScore\r\n        };\r\n      }\r\n  \r\n      return null;\r\n    });\r\n  \r\n    // 等待所有分析完成\r\n    const results = await Promise.all(analysisPromises);\r\n    \r\n    // 过滤并排序结果\r\n    this.filterSearchResults = results.filter(item => item !== null);\r\n    \r\n    if (this.features.searchReordering) {\r\n      this.filterSearchResults.sort((a, b) => b.score - a.score);\r\n      this.reorderSearchResults();\r\n    }\r\n  }\r\n\r\n  setupMutationObserver() {\r\n    // 使用 MutationObserver 替代废弃的 DOM 事件\r\n    const observer = new MutationObserver((mutations) => {\r\n      for (const mutation of mutations) {\r\n        if (mutation.type === 'childList') {\r\n          // 分析新添加的节点\r\n          mutation.addedNodes.forEach(node => {\r\n            if (node.nodeType === Node.ELEMENT_NODE) {\r\n              this.analyzeElement(node);\r\n            }\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    // 配置观察选项\r\n    observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true\r\n    });\r\n  }\r\n\r\n  async analyzeElement(element) {\r\n    try {\r\n      // 检查元素是否可能是广告\r\n      const isAd = await this.analyzeForAd(element);\r\n      if (isAd) {\r\n        element.style.display = 'none';\r\n      }\r\n    } catch (error) {\r\n      console.error('Element analysis failed:', error);\r\n    }\r\n  }\r\n\r\n  async analyzeForAd(content, searchQuery) {\r\n    // 如果广告拦截被禁用，直接返回 false\r\n    if (!this.features.adBlocking) {\r\n      return false;\r\n    }\r\n    \r\n    try {\r\n      const response = await this.makeAPIRequest('analyzeContent', { content, searchQuery });\r\n      // 只返回分析结果，不在这里处理 DOM\r\n      return response && response.isAd === true;\r\n    } catch (error) {\r\n      console.error('Ad analysis failed:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async makeAPIRequest(endpoint, data) {\r\n    try {\r\n      const config = await this.getAPIConfig();\r\n      \r\n      if (!config || !config.apiKey) {\r\n        console.warn(`API configuration incomplete. Provider: ${config?.aiProvider}`);\r\n        return null;\r\n      }\r\n\r\n      // 添加重试逻辑\r\n      const maxRetries = 3;\r\n      let retryCount = 0;\r\n      \r\n      while (retryCount < maxRetries) {\r\n        try {\r\n          const response = await new Promise((resolve, reject) => {\r\n            chrome.runtime.sendMessage({\r\n              type: 'aiRequest',      // 用于消息类型识别\r\n              endpoint: endpoint,      // 用于具体 API 端点识别\r\n              provider: config.aiProvider,\r\n              model: config.aiModel,\r\n              apiKey: config.apiKey,\r\n              data\r\n            }, response => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n                return;\r\n              }\r\n\r\n              if (!response) {\r\n                reject(new Error('Empty response received'));\r\n                return;\r\n              }\r\n\r\n              // 根据不同端点验证响应\r\n              if (endpoint === 'analyzeContent' && typeof response.isAd !== 'boolean') {\r\n                reject(new Error('Invalid analyzeContent response format'));\r\n                return;\r\n              }\r\n              if (endpoint === 'calculateRelevance' && typeof response.relevanceScore !== 'number') {\r\n                reject(new Error('Invalid calculateRelevance response format'));\r\n                return;\r\n              }\r\n\r\n              resolve(response);\r\n            });\r\n          });\r\n\r\n          return response;\r\n        } catch (error) {\r\n          retryCount++;\r\n          if (retryCount === maxRetries) {\r\n            throw error;\r\n          }\r\n          await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('API request failed:', error);\r\n      // 根据端点返回适当的默认值\r\n      return endpoint === 'analyzeContent' ? { isAd: false } : { relevanceScore: 0 };\r\n    }\r\n  }\r\n\r\n  async getAPIConfig() {\r\n    return new Promise((resolve) => {\r\n      const DEFAULT_PROVIDER = 'siliconflow';\r\n      const DEFAULT_MODEL = 'gpt-3.5-turbo';\r\n\r\n      chrome.storage.sync.get({\r\n        // 提供默认值\r\n        aiProvider: DEFAULT_PROVIDER,\r\n        aiModel: DEFAULT_MODEL,\r\n        apiKeys: {}\r\n      }, (result) => {\r\n        console.log('Storage result:', result); // 调试用\r\n        \r\n        const config = {\r\n          apiKey: result.apiKeys[result.aiProvider],\r\n          aiProvider: result.aiProvider,\r\n          aiModel: result.aiModel\r\n        };\r\n        \r\n        console.log('Config:', config); // 调试用\r\n        resolve(config);\r\n      });\r\n    });\r\n  }\r\n\r\n  async analyzeSearchResult(result, searchQuery) {\r\n    // 提取所有可见文本\r\n    const allText = this.getVisibleText(result);\r\n    \r\n    // 进行内容分析\r\n    const isAd = await this.analyzeForAd(allText, searchQuery);\r\n    \r\n    // 在这里处理 DOM 元素的显示/隐藏\r\n    if (isAd && this.features.adBlocking) {\r\n      result.classList.add('ai-assistant-blocked');\r\n      result.style.display = 'none';\r\n    } else {\r\n      result.classList.remove('ai-assistant-blocked');\r\n      result.style.display = '';\r\n    }\r\n    \r\n    return isAd;\r\n  }\r\n\r\n  getSearchQuery() {\r\n    const url = new URL(window.location.href);\r\n    \r\n    // Google 搜索\r\n    if (window.location.hostname.includes('google')) {\r\n      return url.searchParams.get('q');\r\n    }\r\n    // Bing 搜索\r\n    else if (window.location.hostname.includes('bing')) {\r\n      return url.searchParams.get('q');\r\n    }\r\n    // 百度搜索\r\n    else if (window.location.hostname.includes('baidu')) {\r\n      return url.searchParams.get('wd') || url.searchParams.get('word');\r\n    }\r\n    \r\n    return null;\r\n  }\r\n\r\n  // 添加计算相关性的方法\r\n  async calculateRelevance(element, searchQuery) {\r\n    try {\r\n      const content = this.getVisibleText(element);\r\n      \r\n      // 调用AI服务计算相关性\r\n      const response = await this.makeAPIRequest('calculateRelevance', {\r\n        content,\r\n        searchQuery\r\n      });\r\n\r\n      return response?.relevanceScore || 0;\r\n    } catch (error) {\r\n      console.error('计算相关性失败:', error);\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  // 添加重新排序的方法\r\n  reorderSearchResults() {\r\n    if (!this.features.searchReordering || !this.filterSearchResults?.length) {\r\n      return;\r\n    }\r\n\r\n    // 获取第一个元素的父容器\r\n    const container = this.filterSearchResults[0].element.parentElement;\r\n    if (!container) return;\r\n\r\n    // 临时创建一个文档片段来重新排序\r\n    const fragment = document.createDocumentFragment();\r\n    \r\n    // 先将所有元素从 DOM 中移除，并存储到新数组中\r\n    const elements = this.filterSearchResults.map(result => {\r\n      const element = result.element;\r\n      const clone = element.cloneNode(true); // 克隆节点\r\n      clone.classList.add('ai-assistant-reordered');\r\n      return clone;\r\n    });\r\n\r\n    // 将克隆的元素添加到文档片段中\r\n    elements.forEach(element => {\r\n      fragment.appendChild(element);\r\n    });\r\n\r\n    // 清空原容器\r\n    container.innerHTML = '';\r\n    \r\n    // 将重排序后的元素一次性添加回容器\r\n    container.appendChild(fragment);\r\n  }\r\n\r\n  // 将 getVisibleText 方法移到类的方法中\r\n  getVisibleText(element) {\r\n    if (element.offsetParent === null) return '';\r\n    \r\n    if (element.tagName === 'SCRIPT' || \r\n        element.tagName === 'STYLE' || \r\n        element.tagName === 'NOSCRIPT') {\r\n      return '';\r\n    }\r\n\r\n    let text = '';\r\n    for (const node of element.childNodes) {\r\n      if (node.nodeType === Node.TEXT_NODE) {\r\n        const trimmed = node.textContent.trim();\r\n        if (trimmed) text += trimmed + ' ';\r\n      } else if (node.nodeType === Node.ELEMENT_NODE) {\r\n        text += this.getVisibleText(node) + ' ';\r\n      }\r\n    }\r\n    return text.trim();\r\n  }\r\n\r\n  async loadFeatureSettings() {\r\n    try {\r\n      const { features = {} } = await chrome.storage.sync.get('features');\r\n      this.features = {\r\n        adBlocking: false,\r\n        searchReordering: false,\r\n        contextSuggestions: true,\r\n        ...features\r\n      };\r\n      console.log('Loaded features:', this.features);\r\n    } catch (error) {\r\n      console.error('Failed to load feature settings:', error);\r\n    }\r\n  }\r\n\r\n  setAdBlockingEnabled(enabled) {\r\n    this.features.adBlocking = enabled;\r\n    \r\n    // 如果禁用了广告拦截，恢复之前隐藏的广告\r\n    if (!enabled) {\r\n      document.querySelectorAll('.ai-assistant-blocked').forEach(el => {\r\n        el.classList.remove('ai-assistant-blocked');\r\n        el.style.display = ''; // 恢复显示\r\n      });\r\n    }\r\n    \r\n    // 重新分析当前页面内容\r\n    this.analyzeExistingContent();\r\n  }\r\n\r\n  // 辅助方法：根据不同搜索引擎获取搜索结果\r\n  getSearchResultsByEngine() {\r\n    const isGoogle = window.location.hostname.includes('google');\r\n    const isBing = window.location.hostname.includes('bing');\r\n    const isBaidu = window.location.hostname.includes('baidu');\r\n\r\n    if (isGoogle) {\r\n      return Array.from(document.querySelectorAll([\r\n        '#search .g',\r\n        '#rso .g',\r\n        'div[data-sokoban-grid]',\r\n        '.commercial-unit-desktop-top',\r\n        '.commercial-unit-desktop-rhs'\r\n      ].join(','))) || [];\r\n    } \r\n    \r\n    if (isBing) {\r\n      return Array.from(document.querySelectorAll([\r\n        '#b_results > li',\r\n        '.b_ad',\r\n        '.b_algo',\r\n        '.b_sideBleed'\r\n      ].join(','))) || [];\r\n    } \r\n    \r\n    if (isBaidu) {\r\n      return Array.from(document.querySelectorAll([\r\n        '#content_left > div',\r\n        '.result-op',\r\n        '.result',\r\n        '[cmatchid]',\r\n        '.ec_tuiguang_link',\r\n        '#content_right .cr-content',\r\n        '.c-container'\r\n      ].join(','))) || [];\r\n    }\r\n\r\n    return [];\r\n  }\r\n\r\n  setSearchReorderingEnabled(enabled) {\r\n    this.features.searchReordering = enabled;\r\n    \r\n    if (!enabled) {\r\n      // 移除所有重排序相关的类和样式\r\n      document.querySelectorAll('.ai-assistant-reordered').forEach(el => {\r\n        el.classList.remove('ai-assistant-reordered');\r\n        el.style.order = ''; // 移除排序样式\r\n      });\r\n      \r\n      // 恢复原始顺序\r\n      const container = this.filterSearchResults[0]?.element.parentElement;\r\n      if (container) {\r\n        // 获取所有搜索结果\r\n        const results = this.getSearchResultsByEngine();\r\n        \r\n        // 清空容器\r\n        container.innerHTML = '';\r\n        \r\n        // 按原始顺序重新添加元素\r\n        results.forEach(result => {\r\n          container.appendChild(result);\r\n        });\r\n      }\r\n    }\r\n    \r\n    // 重新分析当前页面内容\r\n    this.analyzeExistingContent();\r\n  }\r\n}\r\n\r\n// 初始化内容分析器\r\nconst analyzer = new ContentAnalyzer();\r\n\r\n// 注入悬浮选项\r\nconst iframe = document.createElement('iframe');\r\niframe.src = chrome.runtime.getURL('floating-options/floating-options.html');\r\niframe.style.cssText = `\r\n  position: fixed;\r\n  border: none;\r\n  z-index: 9999;\r\n  background: transparent;\r\n  width: 400px;\r\n  height: 100vh;\r\n  right: 0;\r\n  top: 0;\r\n`;\r\n// 重要：移除 pointer-events: none\r\n// 添加允许交互的样式\r\niframe.style.pointerEvents = 'auto';\r\ndocument.body.appendChild(iframe);\r\n\r\n// 添加消息监听，用于iframe和主页面的通信\r\nwindow.addEventListener('message', (event) => {\r\n  // 确保消息来自你的扩展\r\n  if (event.source === iframe.contentWindow) {\r\n    // 处理来自iframe的消息\r\n    console.log('Received message from iframe:', event.data);\r\n  }\r\n});\r\n\r\n// 在现有的消息监听器中添加处理逻辑\r\nwindow.addEventListener('message', (event) => {\r\n  // 确保消息来自你的扩展\r\n  if (event.source === iframe.contentWindow) {\r\n    const { type, feature, enabled } = event.data;\r\n    \r\n    if (type === 'updateFeature') {\r\n      switch (feature) {\r\n        case 'adBlocking':\r\n          // 更新广告拦截状态\r\n          analyzer.setAdBlockingEnabled(enabled);\r\n          break;\r\n        case 'searchReordering':\r\n          // 更新搜索重排序状态\r\n          analyzer.setSearchReorderingEnabled(enabled);\r\n          break;\r\n        case 'contextSuggestions':\r\n          // 更新上下文建议状态\r\n          analyzer.setContextSuggestionsEnabled(enabled);\r\n          break;\r\n      }\r\n    }\r\n  }\r\n});\r\n\r\n"],"names":[],"sourceRoot":""}