{"version":3,"file":"content/content.js","mappings":";;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yEAAyE,SAAS;AAClF;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA,oBAAoB;AACpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gEAAgE,mBAAmB;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA,eAAe;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,gDAAgD;AAChD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wCAAwC;AACxC;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA;AACA","sources":["webpack://ai-browser-assistant/./src/content/content.js"],"sourcesContent":["// 将需要导入的内容直接定义在文件中\r\nconst CONFIG = {\r\n  adIndicators: [\r\n    'ad', 'ads', 'advertisement', 'sponsored', 'promotion',\r\n    'banner', 'adsense', 'adwords', 'doubleclick'\r\n  ],\r\n  commonAdSizes: [\r\n    [728, 90],  // Leaderboard\r\n    [300, 250], // Medium Rectangle\r\n    [160, 600]  // Wide Skyscraper\r\n  ]\r\n};\r\n\r\nclass ContentAnalyzer {\r\n  constructor() {\r\n    console.trace('ContentAnalyzer constructor called');\r\n    this.initialize();\r\n  }\r\n\r\n  async initialize() {\r\n    try {\r\n      // 初始化配置\r\n      const config = await this.getAPIConfig();\r\n      console.log('Initialized with config:', config);\r\n      \r\n      // 等待 DOM 加载完成\r\n      if (document.readyState === 'loading') {\r\n        document.addEventListener('DOMContentLoaded', () => this.onDOMReady());\r\n      } else {\r\n        this.onDOMReady();\r\n      }\r\n    } catch (error) {\r\n      console.error('Initialization failed:', error);\r\n    }\r\n  }\r\n\r\n  onDOMReady() {\r\n    // 初始分析当前页面内容\r\n    this.analyzeExistingContent();\r\n  }\r\n\r\n  analyzeExistingContent() {\r\n    // 分析页面上现有的元素\r\n    const elements = document.body.getElementsByTagName('*');\r\n    for (const element of elements) {\r\n      this.analyzeElement(element);\r\n    }\r\n  }\r\n\r\n  setupMutationObserver() {\r\n    // 使用 MutationObserver 替代废弃的 DOM 事件\r\n    const observer = new MutationObserver((mutations) => {\r\n      for (const mutation of mutations) {\r\n        if (mutation.type === 'childList') {\r\n          // 分析新添加的节点\r\n          mutation.addedNodes.forEach(node => {\r\n            if (node.nodeType === Node.ELEMENT_NODE) {\r\n              this.analyzeElement(node);\r\n            }\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    // 配置观察选项\r\n    observer.observe(document.body, {\r\n      childList: true,\r\n      subtree: true\r\n    });\r\n  }\r\n\r\n  async analyzeElement(element) {\r\n    try {\r\n      // 检查元素是否可能是广告\r\n      const isAd = await this.analyzeForAd(element);\r\n      if (isAd) {\r\n        element.style.display = 'none';\r\n      }\r\n    } catch (error) {\r\n      console.error('Element analysis failed:', error);\r\n    }\r\n  }\r\n\r\n  async analyzeForAd(element) {\r\n    try {\r\n      // 基本广告特征检查\r\n      const adIndicators = CONFIG.adIndicators;\r\n\r\n      // 检查元素的类名、ID和属性\r\n      const elementText = [\r\n        element.className,\r\n        element.id,\r\n        ...Array.from(element.attributes).map(attr => attr.value)\r\n      ].join(' ').toLowerCase();\r\n\r\n      // 检查是否包含广告相关关键词\r\n      const hasAdKeywords = adIndicators.some(indicator => \r\n        elementText.includes(indicator)\r\n      );\r\n\r\n      // 如果基本检查就发现是广告，直接返回true\r\n      if (hasAdKeywords) {\r\n        return true;\r\n      }\r\n\r\n      // 检查常见广告尺寸\r\n      const commonAdSizes = CONFIG.commonAdSizes;\r\n\r\n      const rect = element.getBoundingClientRect();\r\n      const hasCommonAdSize = commonAdSizes.some(([width, height]) => \r\n        Math.abs(rect.width - width) < 10 && Math.abs(rect.height - height) < 10\r\n      );\r\n\r\n      // 检查iframe源\r\n      const iframes = element.querySelectorAll('iframe');\r\n      const hasAdIframe = Array.from(iframes).some(iframe => {\r\n        const src = iframe.src.toLowerCase();\r\n        return adIndicators.some(indicator => src.includes(indicator));\r\n      });\r\n\r\n      // 如果满足任一条件，可能是广告\r\n      const isLikelyAd = hasCommonAdSize || hasAdIframe;\r\n      debugger\r\n      if (!isLikelyAd) {\r\n        try {\r\n          // 使用 AI 进行进一步分析\r\n          const content = element.outerHTML;\r\n          const response = await this.makeAPIRequest('analyzeContent', { content });\r\n          return response && response.isAd === true;\r\n        } catch (apiError) {\r\n          console.warn('AI analysis failed, falling back to heuristic detection:', apiError);\r\n          // 如果 API 调用失败，回退到基于启发式的判断\r\n          return isLikelyAd;\r\n        }\r\n      }\r\n\r\n      return false;\r\n    } catch (error) {\r\n      console.error('Ad analysis failed:', error);\r\n      return false; // 出错时默认不屏蔽内容\r\n    }\r\n  }\r\n\r\n  async makeAPIRequest(endpoint, data) {\r\n    try {\r\n      const config = await this.getAPIConfig();\r\n      \r\n      if (!config || !config.apiKey) {\r\n        console.warn(`API configuration incomplete. Provider: ${config?.aiProvider}`);\r\n        return null;\r\n      }\r\n\r\n      // 添加重试逻辑\r\n      const maxRetries = 3;\r\n      let retryCount = 0;\r\n      \r\n      while (retryCount < maxRetries) {\r\n        try {\r\n          const response = await new Promise((resolve, reject) => {\r\n            chrome.runtime.sendMessage({\r\n              type: 'aiRequest',\r\n              provider: config.aiProvider,\r\n              model: config.aiModel,\r\n              apiKey: config.apiKey,\r\n              endpoint,\r\n              data\r\n            }, response => {\r\n              if (chrome.runtime.lastError) {\r\n                reject(new Error(chrome.runtime.lastError.message));\r\n                return;\r\n              }\r\n\r\n              if (!response || !response.success) {\r\n                reject(new Error(response?.error || 'API request failed'));\r\n                return;\r\n              }\r\n\r\n              resolve(response.data);\r\n            });\r\n          });\r\n\r\n          // 验证响应数据\r\n          if (!response || typeof response.isAd !== 'boolean') {\r\n            throw new Error('Invalid API response format');\r\n          }\r\n\r\n          return response;\r\n        } catch (error) {\r\n          retryCount++;\r\n          if (retryCount === maxRetries) {\r\n            throw error;\r\n          }\r\n          // 等待一段时间后重试\r\n          await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('API request failed:', error);\r\n      // 返回一个默认的安全响应，而不是 null\r\n      return { isAd: false };\r\n    }\r\n  }\r\n\r\n  async getAPIConfig() {\r\n    return new Promise((resolve) => {\r\n      const DEFAULT_PROVIDER = 'siliconflow';\r\n      const DEFAULT_MODEL = 'gpt-3.5-turbo';\r\n\r\n      chrome.storage.sync.get({\r\n        // 提供默认值\r\n        aiProvider: DEFAULT_PROVIDER,\r\n        aiModel: DEFAULT_MODEL,\r\n        apiKeys: {}\r\n      }, (result) => {\r\n        console.log('Storage result:', result); // 调试用\r\n        \r\n        const config = {\r\n          apiKey: result.apiKeys[result.aiProvider],\r\n          aiProvider: result.aiProvider,\r\n          aiModel: result.aiModel\r\n        };\r\n        \r\n        console.log('Config:', config); // 调试用\r\n        resolve(config);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\n// 初始化内容分析器\r\nconst analyzer = new ContentAnalyzer();\r\n"],"names":[],"sourceRoot":""}